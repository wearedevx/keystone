name: use-keystone-action

on: [push]

jobs:
  use_keystone-action:
    runs-on: ubuntu-latest
    name: A job to make keystone-ci usable secrets
    steps:
      # To use this repository's private action,
      # you must check out the repository
      - name: Checkout
        uses: actions/checkout@v2

      - name: Load Secrets
        uses: wearedevx/keystone-action@feat/read-message
        id: load_secrets
        with:
          token: ${{ secrets.DEPLOY_GITHUB_TOKEN }}
          # Normally, we would use 
          # kestone_slot: ${{ secrets.KEYSTONE_SLOT }}
          keystone_slot: |-
            {
              "secrets": [
                {"label": "TEST", "value": "secretvalue"}
              ],
              "files: [
                {
                  "path": "ks_temp/test.txt",
                  "content": "Q2VjaSBlc3QgdW4gdGVzdA==",
                }
              ]
            }

      - name: Show Secrets
        id: show_secrets
        run: |
          echo "From env action context: ${{ env.TEST }}"
          echo "From runner job environment variables $TEST"

      - name: Test there is a file
        id: test_file
        run: |
          F="ks_temp/test.txt";

          if [ -f $F ]; then
            echo "$F exists";
            C=`cat $F`;

            if [ $C == "Ceci est un test" ]; then
              echo "It has the right content";
            else
              echo "::error File value is not right";
            fi
          else
            echo "::error $F does not exits";
          fi

